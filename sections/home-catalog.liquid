<div class="home-catalog" {% if section.settings.default_collection != blank %}data-default="{{ section.settings.default_collection.handle }}"{% endif %}>
  <!-- Filter Menu -->
  <nav class="filter-menu">
    {% assign default_filter = 'all' %}
    {% if section.settings.default_collection != blank %}
      {% assign default_filter = section.settings.default_collection.handle %}
    {% endif %}
    
    <button class="filter-link {% if default_filter == 'all' %}active{% endif %}" data-filter="all" onclick="filterProducts('all')">all</button>
    
    {% comment %} Sort collections alphabetically by title {% endcomment %}
    {% assign sorted_collections = collections | sort: 'title' %}
    {% for collection in sorted_collections %}
      {% unless collection.handle == 'all' or collection.handle == 'frontpage' %}
        <button class="filter-link {% if default_filter == collection.handle %}active{% endif %}" data-filter="{{ collection.handle }}" onclick="filterProducts('{{ collection.handle }}')">{{ collection.title | downcase }}</button>
      {% endunless %}
    {% endfor %}
  </nav>

  <!-- Product Grid -->
  {% paginate collections.all.products by 200 %}
    <div class="product-grid" id="product-grid">
      {% comment %} First loop: Render all AVAILABLE products {% endcomment %}
      {% for product in collections.all.products %}
        {% if product.available %}
          {% comment %} Get all collection handles this product belongs to (space-separated) {% endcomment %}
          {% assign product_collections = '' %}
          {% for collection in product.collections %}
            {% if product_collections == '' %}
              {% assign product_collections = collection.handle %}
            {% else %}
              {% assign product_collections = product_collections | append: ' ' | append: collection.handle %}
            {% endif %}
          {% endfor %}
          
          {% comment %} Check if new (has "new" tag OR published within 30 days) {% endcomment %}
          {% assign is_new = false %}
          {% if product.tags contains 'new' %}
            {% assign is_new = true %}
          {% else %}
            {% comment %} Check if published within last 30 days {% endcomment %}
            {% assign published_timestamp = product.published_at | date: '%s' | plus: 0 %}
            {% assign current_timestamp = 'now' | date: '%s' | plus: 0 %}
            {% assign seconds_since_published = current_timestamp | minus: published_timestamp %}
            {% assign days_since_published = seconds_since_published | divided_by: 86400 %}
            {% if days_since_published <= 30 and days_since_published >= 0 %}
              {% assign is_new = true %}
            {% endif %}
          {% endif %}
          
          <a 
            href="{{ product.url }}" 
            class="product-card" 
            data-collection-handles="{{ product_collections }}"
          >
            <div class="product-image">
              <div class="image-carousel-container">
                {% assign image_count = 0 %}
                {% for image in product.images limit: 5 %}
                  {% assign image_count = image_count | plus: 1 %}
                  {% if image_count == 1 %}
                    <img 
                      src="{{ image | img_url: '600x800' }}" 
                      alt="{{ product.title | escape }}"
                      {% if forloop.parentloop.first %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}
                      class="active-img"
                    >
                  {% else %}
                    <img 
                      data-src="{{ image | img_url: '600x800' }}" 
                      alt="{{ product.title | escape }}"
                      class="inactive-img"
                    >
                  {% endif %}
                {% endfor %}
                {% if image_count == 0 %}
                  <div class="no-image">no image</div>
                {% else %}
                  {% if image_count > 1 %}
                    <button class="carousel-arrow-ghost prev" data-direction="prev">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.5 9L4.5 6L7.5 3" stroke="#7E857A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="carousel-arrow-ghost next" data-direction="next">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.5 3L7.5 6L4.5 9" stroke="#7E857A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  {% endif %}
                {% endif %}
              </div>
            </div>
            <div class="product-title">
              {{ product.title }}
              {% if is_new %}
                <span class="new-badge">[new]</span>
              {% endif %}
            </div>
            <div class="product-price">
              {{ product.price | money }}
            </div>
          </a>
        {% endif %}
      {% endfor %}
      
      {% comment %} Second loop: Render all SOLD OUT products {% endcomment %}
      {% for product in collections.all.products %}
        {% unless product.available %}
          {% comment %} Get all collection handles this product belongs to (space-separated) {% endcomment %}
          {% assign product_collections = '' %}
          {% for collection in product.collections %}
            {% if product_collections == '' %}
              {% assign product_collections = collection.handle %}
            {% else %}
              {% assign product_collections = product_collections | append: ' ' | append: collection.handle %}
            {% endif %}
          {% endfor %}
          
          <a 
            href="{{ product.url }}" 
            class="product-card is-sold-out" 
            data-collection-handles="{{ product_collections }}"
          >
            <div class="product-image">
              <div class="image-carousel-container">
                {% assign image_count = 0 %}
                {% for image in product.images limit: 5 %}
                  {% assign image_count = image_count | plus: 1 %}
                  {% if image_count == 1 %}
                    <img 
                      src="{{ image | img_url: '600x800' }}" 
                      alt="{{ product.title | escape }}"
                      loading="lazy"
                      class="active-img"
                    >
                  {% else %}
                    <img 
                      data-src="{{ image | img_url: '600x800' }}" 
                      alt="{{ product.title | escape }}"
                      class="inactive-img"
                    >
                  {% endif %}
                {% endfor %}
                {% if image_count == 0 %}
                  <div class="no-image">no image</div>
                {% else %}
                  {% if image_count > 1 %}
                    <button class="carousel-arrow-ghost prev" data-direction="prev">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.5 9L4.5 6L7.5 3" stroke="#7E857A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="carousel-arrow-ghost next" data-direction="next">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.5 3L7.5 6L4.5 9" stroke="#7E857A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  {% endif %}
                {% endif %}
              </div>
            </div>
            <div class="product-title">
              {{ product.title }}
            </div>
            <div class="product-price">
              sold out
            </div>
          </a>
        {% endunless %}
      {% endfor %}
    </div>
  {% endpaginate %}
</div>

<style>
  .home-catalog {
    padding: 20px 0;
  }

  /* Filter Menu */
  .filter-menu {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 30px;
    padding: 0 20px;
  }

  .filter-link {
    font-family: Arial, Helvetica, sans-serif !important;
    font-size: 12px !important;
    line-height: 1.25 !important;
    text-transform: lowercase !important;
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
    cursor: pointer !important;
    color: #7E857A !important;
    text-decoration: none !important;
    font-weight: 400 !important;
    border-radius: 0 !important;
    transition: text-decoration 0.2s;
    display: inline !important;
  }

  .filter-link:hover {
    text-decoration: underline !important;
    color: #7E857A !important;
  }

  .filter-link.active {
    color: #7E857A !important;
    font-weight: 700 !important;
    text-decoration: none !important;
  }

  /* Product Grid */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    padding: 0 20px;
  }

  .product-card {
    text-decoration: none;
    color: #7E857A;
    display: block;
  }

  .product-image {
    aspect-ratio: 3/4;
    overflow: hidden;
    margin-bottom: 10px;
    position: relative;
  }

  .product-image .image-carousel-container {
    width: 100%;
    height: 100%;
  }

  .product-image .no-image {
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999999;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
    text-transform: lowercase;
    position: absolute;
    inset: 0;
  }

  .no-image {
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999999;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
    text-transform: lowercase;
  }

  .product-title {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
    line-height: 1.25;
    text-transform: lowercase;
    margin-bottom: 5px;
  }

  .new-badge {
    font-style: italic;
    margin-left: 5px;
  }

  .product-price {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
    line-height: 1.25;
    text-transform: lowercase;
  }

  /* Sold Out Styling */
  .product-card.is-sold-out {
    opacity: 0.5;
    color: #888888;
  }

  .product-card.is-sold-out .product-image .image-carousel-container img {
    filter: grayscale(100%);
  }

  /* Hide filtered products */
  .product-card.hidden {
    display: none;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .product-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 0 15px;
    }

    .filter-menu {
      gap: 15px;
      padding: 0 15px;
    }
  }
</style>

<script>
  function filterProducts(collectionHandle) {
    // Update active state immediately (so user knows button worked)
    const filterLinks = document.querySelectorAll('.filter-link');
    filterLinks.forEach(link => {
      link.classList.remove('active');
      if (link.dataset.filter === collectionHandle) {
        link.classList.add('active');
      }
    });

    // Get grid container
    const productGrid = document.getElementById('product-grid');
    if (!productGrid) return;

    // Add filtering class to fade out
    productGrid.classList.add('is-filtering');

    // Wait for fade out, then update content
    setTimeout(() => {
      // Filter products
      const productCards = document.querySelectorAll('.product-card');
      
      productCards.forEach(card => {
        if (collectionHandle === 'all') {
          card.classList.remove('hidden');
        } else {
          const handles = card.dataset.collectionHandles || '';
          const handlesArray = handles.split(' ').map(h => h.trim()).filter(h => h);
          
          if (handlesArray.includes(collectionHandle)) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        }
      });

      // Remove filtering class to fade back in
      productGrid.classList.remove('is-filtering');
    }, 200);
  }

  // Initialize: check for default collection
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.home-catalog');
    const defaultHandle = container ? container.dataset.default : null;
    
    if (defaultHandle) {
      filterProducts(defaultHandle);
    } else {
      filterProducts('all');
    }
  });
</script>

{% schema %}
{
  "name": "Home Catalog",
  "settings": [
    {
      "type": "collection",
      "id": "default_collection",
      "label": "Default Selected Collection",
      "info": "Choose which collection is shown immediately when the page loads. Leave blank to show all products."
    }
  ]
}
{% endschema %}
